<!DOCTYPE html>
<html lang="en">
<head>
<title>Inequality along Philadelphia transit lines</title>
<meta charset="UTF-8"/>

<style>
	.septa_route {stroke: gray; stroke-width:0px; fill-opacity:.5; opacity: 1}

	#tooltip {
	    position: absolute;
	    width: 200px;
	    height: auto;
	    padding: 10px;
	    background-color: white;
	    -webkit-box-shadow: 0px 0px 4px rgba(0, 0, 0, 0.4);
	    -moz-box-shadow: 0px 0px 4px rgba(0, 0, 0, 0.4);
	    box-shadow: 0px 0px 4px rgba(0, 0, 0, 0.4);
	    pointer-events: none;
	    opacity: 1;
	  }

  #routes li {
    padding: 5px;
    margin: 5px;
    border-radius: 5px;
    float: left;
    list-style: none;
  }
  #routes li a {
    color: #FFF;
  }
  #stops {
    display: block;
    height: 35px;
  }
  #loading { position: absolute; left: 250px; top: 200px;}
  #graph svg {
    border: 1px solid #999;
  }
  #graph {
    float: left;
    margin: 0 0 0 50px;
  }
  #map {
    float: left;
    clear: both;
  }
  #map svg { border: 1px solid #999; }

</style>
</head>
<body>
  <div id="container">
    <div class="top">
      <div id="routes"><h2>Routes</h2><ul></ul></div>
      <div id="map">
        <h2>Map</h2>
        <div id="loading">loading..</div>
      </div>
      <div id="graph">
         <h2>Graph</h2>
       </div>
    </div>
  </div>
  <div id="tooltip" style="display:none"></div>

  <script src="assets/js/d3.v3.min.js"></script>
  <script src="assets/js/jquery-latest.js"></script>

  <script>
  $(document).ready(function() {

    var censusKey = 'f5bd9c51b563f034639bab7be5bb546c1b456cdc';
		var w = 600;
		var h = 600;

		var svg = d3.select("#map")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

	  var projection = d3.geo.mercator()
                       .center([-75.205219, 40.00061])
                       .translate([w/2, h/2])
                       .scale([71000]);

	  var path = d3.geo.path().projection(projection);

		var g = svg.append("g");
    d3.json("http://demo.getdkan.com/api/action/datastore/search.json?resource_id[stops]=8ebe73a0-5bee-4726-8a6d-d1ecb135fc2e&resource_id[routes]=f727b1f2-3d0a-4153-97d0-adfd64ffa234&limit=500&join[stops]=stop_desc&join[routes]=route_short_name", function(error, stops_data) {
      $('#loading').hide();
			g.selectAll("circles.points")
	      .data(stops_data.records)
			  .enter()
				.append("circle")
				.attr("r",5)
        .attr("class", function(d) { return "route_" + d.route_id;})
				.attr("transform", function(d) {return "translate(" + projection([d.stop_lon,d.stop_lat]) + ")";})
	      .style("fill", function(d) { return d.route_color; });

      g.selectAll("circle")
        .on("mouseover", function(d) {
          d3.select(this)
            .transition()
            .delay(250)
            .attr("r", 8);

            var pageX = d3.event.pageX;
            var pageY = d3.event.pageY;
            d3.select("#tooltip")
              .style("left", (pageX) + 20 + "px")
              .style("top", (pageY) - 30 + "px")
              .style("display", "block")
              .transition()
              .text(d.route_long_name + ': ' + d.stop_name + 'loading...');

            var fccUrl = "http://data.fcc.gov/api/block/find?format=jsonp&latitude=" + d.stop_lat + "&longitude=" + d.stop_lon + "&callback=?";
            $.getJSON(fccUrl, null, function (results) {
              var FIPS = results.Block.FIPS;
              var stateFip = FIPS.substring(0,2);
              var countyFip = FIPS.substring(2,5);
              var tractFip = FIPS.substring(5,11);
              var censusUrl = 'http://api.census.gov/data/2011/acs5?key=' + censusKey + '&get=B19013_001E,NAME&for=block+group:1&in=state:' + stateFip + '+county:' + countyFip + '+tract:' + tractFip;
              $.getJSON(censusUrl, function(data) {
                d3.select("#tooltip")
                  .style("left", (pageX) + 20 + "px")
                  .style("top", (pageY) - 30 + "px")
                  .style("display", "block")
                  .transition()
                  .text(d.route_long_name + ': ' + d.stop_name + '$' + commaSeparateNumber(data[1][0]));
              });
            });
		  });

      g.selectAll("circle")
        .on("mouseout", function(d) {
			  		d3.select(this)
				    	.transition()
				    	.attr("r", 5);
            $('#tooltip').hide();
        });
      var routes = {};
      // Lines
      $.each(stops_data.records, function(key, value){
        routes[value.route_id] = {name: value.route_short_name, color: value.route_color};
      });
      $.each(routes, function(id, items) {
        $('#routes ul').append('<li style="background-color: #' + items.color + '"><a href="#' + id  + '">' + items.name + '</a></li>');
      });


      // Action.
      d3.selectAll("#routes ul li a")
        .on("click", function (d) {console.log(d)});

      function moveItMoveIt(id) {
        console.log(id);
        g.selectAll("circle")
          .transition()
          .attr("r", 2);
        g.selectAll("circle.route_" + id)
          .transition()
          .attr("r", 5);

        var graphData = {};
        // TODO: make more efficient.
        var x = 1;
        g2 = d3.select("#chart")
          .append("g")
        $.each(stops_data.records, function(key, de) {
          if (de.route_id == id) {
            console.log(de);
            var fccUrl = "http://data.fcc.gov/api/block/find?format=jsonp&latitude=" + de.stop_lat + "&longitude=" + de.stop_lon + "&callback=?";
            $.getJSON(fccUrl, null, function (results) {
              var FIPS = results.Block.FIPS;
              var stateFip = FIPS.substring(0,2);
              var countyFip = FIPS.substring(2,5);
              var tractFip = FIPS.substring(5,11);
              var censusUrl = 'http://api.census.gov/data/2011/acs5?key=' + censusKey + '&get=B19013_001E,NAME&for=block+group:1&in=state:' + stateFip + '+county:' + countyFip + '+tract:' + tractFip;
              $.getJSON(censusUrl, function(data) {
                graphData = {name: de.stop_name, data: data[1][0], color: de.route_color};
                console.log(graphData);
                chart.append("circle")
                  .datum(graphData)
                  .transition()
                  .attr("r", 4)
                  .style("fill", function(d) {return '#' + d.color; })
                  .attr("cx", function(d) {return stop_scale(x)})
                  .attr("cy", function(d) {return income_scale(d.data)});
                x++;
              });
            });
          }
        });
      }

      // Graph.
      // TODO: http://bost.ocks.org/mike/chart/
      var container_dimensions = {width: 500, height: 400},
                     margins = {top: 20, right: 20, bottom: 30, left: 118},
                     chart_dimensions = { width: container_dimensions.width - margins.left - margins.right-20,
                                          height: container_dimensions.height - margins.top - margins.bottom };
      var chart = d3.select("#graph")
        .append("svg")
        .attr("width", container_dimensions.width)
        .attr("height", container_dimensions.height)
        .append("g")
        .attr("transform", "translate(" + margins.left + "," + margins.top + ")")
        .attr("id","chart");

      var stop_scale = d3.scale.linear()
        .range([0,chart_dimensions.width])
        .domain([1, 10]);

      var income_scale = d3.scale.linear()
        .range([chart_dimensions.height, 0])
        .domain([0,230000]);

      var income_axis = d3.svg.axis()
        .scale(income_scale)
        .orient("left")
        .tickValues([0, 50000, 100000, 150000, 200000])
        .tickSize(-chart_dimensions.width, 0)
        .tickPadding(20)
        .tickFormat(function(d) { return "$" + d; });

      //append the y axis
      chart.append("g")
           .attr("class", "y axis")
           .call(income_axis);
      d3.select(".y.axis")
        .append("text")
        .attr("text-anchor","middle")
        .text("median household income")
        .attr("transform", "rotate (270, 0, 0)")
        .attr("x", -180)
        .attr("y", -110);

		});

		// ht: http://stackoverflow.com/a/12947816
		function commaSeparateNumber(val){
		    while (/(\d+)(\d{3})/.test(val.toString())){
		      val = val.toString().replace(/(\d+)(\d{3})/, '$1'+','+'$2');
		    }
		    return val;
		 }



	});

  </script>

  </body>
</html>
